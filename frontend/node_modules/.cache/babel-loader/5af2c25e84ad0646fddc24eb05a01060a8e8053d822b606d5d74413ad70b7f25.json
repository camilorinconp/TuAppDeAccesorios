{"ast":null,"code":"import _objectSpread from\"/Users/user/TuAppDeAccesorios/frontend/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";import React,{useState,useEffect}from'react';import ErrorNotification from'../components/ErrorNotification';import{useApiError}from'../hooks/useApiError';import{apiRequest}from'../services/api';import{jsx as _jsx,jsxs as _jsxs}from\"react/jsx-runtime\";const ConsignmentLoansPage=()=>{const[loans,setLoans]=useState([]);const[products,setProducts]=useState([]);const[distributors,setDistributors]=useState([]);const[showCreateForm,setShowCreateForm]=useState(false);const[newLoan,setNewLoan]=useState({distributor_id:'',product_id:'',quantity_loaned:'',loan_date:new Date().toISOString().split('T')[0],return_due_date:'',status:'en_prestamo'});const[success,setSuccess]=useState(null);const{error,isLoading,clearError,executeWithErrorHandling}=useApiError();useEffect(()=>{fetchData();},[]);const fetchData=async()=>{await executeWithErrorHandling(async()=>{const[loansResponse,productsResponse,distributorsResponse]=await Promise.all([apiRequest('/consignments/loans?skip=0&limit=100'),apiRequest('/products/?skip=0&limit=100'),apiRequest('/distributors/')]);setLoans(loansResponse||[]);setProducts((productsResponse===null||productsResponse===void 0?void 0:productsResponse.products)||[]);setDistributors(distributorsResponse||[]);});};const handleCreateLoan=async e=>{e.preventDefault();setSuccess(null);const selectedProduct=products.find(p=>p.id===parseInt(newLoan.product_id));const requestedQuantity=parseInt(newLoan.quantity_loaned);if(!selectedProduct){clearError();return;}if(requestedQuantity>selectedProduct.stock_quantity){alert(\"Error: Stock insuficiente. Disponible: \".concat(selectedProduct.stock_quantity,\", Solicitado: \").concat(requestedQuantity));return;}await executeWithErrorHandling(async()=>{// Calcular fecha de vencimiento si no se especifica (30 días por defecto)\nconst returnDate=newLoan.return_due_date||new Date(Date.now()+30*24*60*60*1000).toISOString().split('T')[0];const loanData={distributor_id:parseInt(newLoan.distributor_id),product_id:parseInt(newLoan.product_id),quantity_loaned:requestedQuantity,loan_date:newLoan.loan_date,return_due_date:returnDate,status:newLoan.status};await apiRequest('/consignments/loans',{method:'POST',body:JSON.stringify(loanData)});setSuccess(\"Pr\\xE9stamo creado exitosamente. Stock actualizado autom\\xE1ticamente.\");setNewLoan({distributor_id:'',product_id:'',quantity_loaned:'',loan_date:new Date().toISOString().split('T')[0],return_due_date:'',status:'en_prestamo'});setShowCreateForm(false);await fetchData();// Refrescar datos\n});};const getProductInfo=productId=>{return products.find(p=>p.id===productId);};const getDistributorInfo=distributorId=>{return distributors.find(d=>d.id===distributorId);};const calculateDaysUntilDue=dueDate=>{const today=new Date();const due=new Date(dueDate);const diffTime=due.getTime()-today.getTime();const diffDays=Math.ceil(diffTime/(1000*60*60*24));return diffDays;};const getStatusColor=status=>{switch(status){case'en_prestamo':return'#007bff';case'devuelto':return'#28a745';case'vencido':return'#dc3545';default:return'#6c757d';}};const selectedProduct=products.find(p=>p.id===parseInt(newLoan.product_id));return/*#__PURE__*/_jsxs(\"div\",{style:{padding:'20px'},children:[/*#__PURE__*/_jsxs(\"div\",{style:{display:'flex',justifyContent:'space-between',alignItems:'center',marginBottom:'20px'},children:[/*#__PURE__*/_jsx(\"h1\",{children:\"\\uD83C\\uDFEA Gesti\\xF3n de Pr\\xE9stamos de Consignaci\\xF3n\"}),/*#__PURE__*/_jsx(\"button\",{onClick:()=>setShowCreateForm(!showCreateForm),style:{padding:'10px 20px',backgroundColor:'#28a745',color:'white',border:'none',borderRadius:'4px',cursor:'pointer'},children:showCreateForm?'Cancelar':'+ Crear Préstamo'})]}),/*#__PURE__*/_jsx(ErrorNotification,{error:error,onClose:clearError}),success&&/*#__PURE__*/_jsx(\"div\",{style:{padding:'10px',backgroundColor:'#d4edda',border:'1px solid #c3e6cb',borderRadius:'4px',color:'#155724',marginBottom:'20px'},children:success}),showCreateForm&&/*#__PURE__*/_jsxs(\"div\",{style:{marginBottom:'30px',border:'1px solid #ddd',padding:'20px',borderRadius:'8px',backgroundColor:'#f8f9fa'},children:[/*#__PURE__*/_jsx(\"h2\",{children:\"\\uD83D\\uDCDD Crear Nuevo Pr\\xE9stamo\"}),/*#__PURE__*/_jsxs(\"form\",{onSubmit:handleCreateLoan,style:{display:'grid',gridTemplateColumns:'1fr 1fr',gap:'15px'},children:[/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"label\",{style:{display:'block',marginBottom:'5px',fontWeight:'bold'},children:\"Distribuidor:\"}),/*#__PURE__*/_jsxs(\"select\",{value:newLoan.distributor_id,onChange:e=>setNewLoan(_objectSpread(_objectSpread({},newLoan),{},{distributor_id:e.target.value})),required:true,style:{width:'100%',padding:'8px',borderRadius:'4px',border:'1px solid #ccc'},children:[/*#__PURE__*/_jsx(\"option\",{value:\"\",children:\"Seleccionar distribuidor...\"}),distributors.map(dist=>/*#__PURE__*/_jsxs(\"option\",{value:dist.id,children:[dist.name,\" (C\\xF3digo: \",dist.access_code,\")\"]},dist.id))]})]}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"label\",{style:{display:'block',marginBottom:'5px',fontWeight:'bold'},children:\"Producto:\"}),/*#__PURE__*/_jsxs(\"select\",{value:newLoan.product_id,onChange:e=>setNewLoan(_objectSpread(_objectSpread({},newLoan),{},{product_id:e.target.value})),required:true,style:{width:'100%',padding:'8px',borderRadius:'4px',border:'1px solid #ccc'},children:[/*#__PURE__*/_jsx(\"option\",{value:\"\",children:\"Seleccionar producto...\"}),products.map(product=>/*#__PURE__*/_jsxs(\"option\",{value:product.id,children:[product.name,\" - Stock: \",product.stock_quantity,\" ($\",product.selling_price.toLocaleString('es-CO'),\")\"]},product.id))]})]}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"label\",{style:{display:'block',marginBottom:'5px',fontWeight:'bold'},children:\"Cantidad a Prestar:\"}),/*#__PURE__*/_jsx(\"input\",{type:\"number\",value:newLoan.quantity_loaned,onChange:e=>setNewLoan(_objectSpread(_objectSpread({},newLoan),{},{quantity_loaned:e.target.value})),min:\"1\",max:(selectedProduct===null||selectedProduct===void 0?void 0:selectedProduct.stock_quantity)||999,required:true,style:{width:'100%',padding:'8px',borderRadius:'4px',border:'1px solid #ccc'}}),selectedProduct&&/*#__PURE__*/_jsxs(\"small\",{style:{color:'#666'},children:[\"Stock disponible: \",selectedProduct.stock_quantity,\" unidades\"]})]}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"label\",{style:{display:'block',marginBottom:'5px',fontWeight:'bold'},children:\"Fecha de Pr\\xE9stamo:\"}),/*#__PURE__*/_jsx(\"input\",{type:\"date\",value:newLoan.loan_date,onChange:e=>setNewLoan(_objectSpread(_objectSpread({},newLoan),{},{loan_date:e.target.value})),required:true,style:{width:'100%',padding:'8px',borderRadius:'4px',border:'1px solid #ccc'}})]}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsx(\"label\",{style:{display:'block',marginBottom:'5px',fontWeight:'bold'},children:\"Fecha de Vencimiento:\"}),/*#__PURE__*/_jsx(\"input\",{type:\"date\",value:newLoan.return_due_date,onChange:e=>setNewLoan(_objectSpread(_objectSpread({},newLoan),{},{return_due_date:e.target.value})),style:{width:'100%',padding:'8px',borderRadius:'4px',border:'1px solid #ccc'}}),/*#__PURE__*/_jsx(\"small\",{style:{color:'#666'},children:\"Opcional: 30 d\\xEDas por defecto desde la fecha de pr\\xE9stamo\"})]}),/*#__PURE__*/_jsxs(\"div\",{style:{gridColumn:'1 / -1',display:'flex',gap:'10px',justifyContent:'flex-end'},children:[/*#__PURE__*/_jsx(\"button\",{type:\"button\",onClick:()=>setShowCreateForm(false),style:{padding:'10px 20px',backgroundColor:'#6c757d',color:'white',border:'none',borderRadius:'4px',cursor:'pointer'},children:\"Cancelar\"}),/*#__PURE__*/_jsx(\"button\",{type:\"submit\",disabled:isLoading,style:{padding:'10px 20px',backgroundColor:'#28a745',color:'white',border:'none',borderRadius:'4px',cursor:'pointer',opacity:isLoading?0.6:1},children:isLoading?'Creando...':'Crear Préstamo'})]})]}),selectedProduct&&newLoan.quantity_loaned&&/*#__PURE__*/_jsxs(\"div\",{style:{marginTop:'20px',padding:'15px',backgroundColor:'#e3f2fd',borderRadius:'4px',border:'1px solid #bbdefb'},children:[/*#__PURE__*/_jsx(\"h4\",{children:\"\\uD83D\\uDCCA Resumen del Pr\\xE9stamo:\"}),/*#__PURE__*/_jsxs(\"p\",{children:[/*#__PURE__*/_jsx(\"strong\",{children:\"Producto:\"}),\" \",selectedProduct.name]}),/*#__PURE__*/_jsxs(\"p\",{children:[/*#__PURE__*/_jsx(\"strong\",{children:\"Stock actual:\"}),\" \",selectedProduct.stock_quantity]}),/*#__PURE__*/_jsxs(\"p\",{children:[/*#__PURE__*/_jsx(\"strong\",{children:\"Cantidad a prestar:\"}),\" \",newLoan.quantity_loaned]}),/*#__PURE__*/_jsxs(\"p\",{children:[/*#__PURE__*/_jsx(\"strong\",{children:\"Stock despu\\xE9s del pr\\xE9stamo:\"}),\" \",selectedProduct.stock_quantity-parseInt(newLoan.quantity_loaned||'0')]}),/*#__PURE__*/_jsxs(\"p\",{children:[/*#__PURE__*/_jsx(\"strong\",{children:\"Valor total prestado:\"}),\" $\",(selectedProduct.selling_price*parseInt(newLoan.quantity_loaned||'0')).toLocaleString('es-CO'),\" COP\"]})]})]}),/*#__PURE__*/_jsxs(\"div\",{children:[/*#__PURE__*/_jsxs(\"h2\",{children:[\"\\uD83D\\uDCCB Pr\\xE9stamos Activos (\",loans.length,\")\"]}),isLoading&&/*#__PURE__*/_jsx(\"div\",{style:{textAlign:'center',padding:'20px'},children:\"Cargando pr\\xE9stamos...\"}),/*#__PURE__*/_jsx(\"div\",{style:{overflowX:'auto'},children:/*#__PURE__*/_jsxs(\"table\",{style:{width:'100%',borderCollapse:'collapse'},children:[/*#__PURE__*/_jsx(\"thead\",{children:/*#__PURE__*/_jsxs(\"tr\",{style:{backgroundColor:'#f8f9fa'},children:[/*#__PURE__*/_jsx(\"th\",{style:{border:'1px solid #ddd',padding:'12px',textAlign:'left'},children:\"ID\"}),/*#__PURE__*/_jsx(\"th\",{style:{border:'1px solid #ddd',padding:'12px',textAlign:'left'},children:\"Distribuidor\"}),/*#__PURE__*/_jsx(\"th\",{style:{border:'1px solid #ddd',padding:'12px',textAlign:'left'},children:\"Producto\"}),/*#__PURE__*/_jsx(\"th\",{style:{border:'1px solid #ddd',padding:'12px',textAlign:'right'},children:\"Cantidad\"}),/*#__PURE__*/_jsx(\"th\",{style:{border:'1px solid #ddd',padding:'12px',textAlign:'right'},children:\"Valor Total\"}),/*#__PURE__*/_jsx(\"th\",{style:{border:'1px solid #ddd',padding:'12px',textAlign:'center'},children:\"Fecha Pr\\xE9stamo\"}),/*#__PURE__*/_jsx(\"th\",{style:{border:'1px solid #ddd',padding:'12px',textAlign:'center'},children:\"Vencimiento\"}),/*#__PURE__*/_jsx(\"th\",{style:{border:'1px solid #ddd',padding:'12px',textAlign:'center'},children:\"Estado\"}),/*#__PURE__*/_jsx(\"th\",{style:{border:'1px solid #ddd',padding:'12px',textAlign:'center'},children:\"D\\xEDas Restantes\"})]})}),/*#__PURE__*/_jsx(\"tbody\",{children:loans.map(loan=>{const product=getProductInfo(loan.product_id);const distributor=getDistributorInfo(loan.distributor_id);const daysUntilDue=calculateDaysUntilDue(loan.return_due_date);const isOverdue=daysUntilDue<0;return/*#__PURE__*/_jsxs(\"tr\",{style:{backgroundColor:isOverdue?'#fff3cd':'white'},children:[/*#__PURE__*/_jsxs(\"td\",{style:{border:'1px solid #ddd',padding:'8px'},children:[\"#\",loan.id]}),/*#__PURE__*/_jsxs(\"td\",{style:{border:'1px solid #ddd',padding:'8px'},children:[(distributor===null||distributor===void 0?void 0:distributor.name)||\"ID: \".concat(loan.distributor_id),/*#__PURE__*/_jsx(\"br\",{}),/*#__PURE__*/_jsxs(\"small\",{style:{color:'#666'},children:[\"C\\xF3digo: \",(distributor===null||distributor===void 0?void 0:distributor.access_code)||'N/A']})]}),/*#__PURE__*/_jsxs(\"td\",{style:{border:'1px solid #ddd',padding:'8px'},children:[(product===null||product===void 0?void 0:product.name)||\"ID: \".concat(loan.product_id),/*#__PURE__*/_jsx(\"br\",{}),/*#__PURE__*/_jsxs(\"small\",{style:{color:'#666'},children:[\"SKU: \",(product===null||product===void 0?void 0:product.sku)||'N/A']})]}),/*#__PURE__*/_jsx(\"td\",{style:{border:'1px solid #ddd',padding:'8px',textAlign:'right'},children:loan.quantity_loaned}),/*#__PURE__*/_jsxs(\"td\",{style:{border:'1px solid #ddd',padding:'8px',textAlign:'right'},children:[\"$\",(((product===null||product===void 0?void 0:product.selling_price)||0)*loan.quantity_loaned).toLocaleString('es-CO')]}),/*#__PURE__*/_jsx(\"td\",{style:{border:'1px solid #ddd',padding:'8px',textAlign:'center'},children:loan.loan_date}),/*#__PURE__*/_jsx(\"td\",{style:{border:'1px solid #ddd',padding:'8px',textAlign:'center'},children:loan.return_due_date}),/*#__PURE__*/_jsx(\"td\",{style:{border:'1px solid #ddd',padding:'8px',textAlign:'center'},children:/*#__PURE__*/_jsx(\"span\",{style:{padding:'4px 8px',borderRadius:'12px',color:'white',backgroundColor:getStatusColor(loan.status),fontSize:'12px'},children:loan.status.replace('_',' ').toUpperCase()})}),/*#__PURE__*/_jsx(\"td\",{style:{border:'1px solid #ddd',padding:'8px',textAlign:'center'},children:/*#__PURE__*/_jsx(\"span\",{style:{color:isOverdue?'#dc3545':daysUntilDue<=7?'#ffc107':'#28a745',fontWeight:'bold'},children:isOverdue?\"Vencido \".concat(Math.abs(daysUntilDue),\" d\\xEDas\"):\"\".concat(daysUntilDue,\" d\\xEDas\")})})]},loan.id);})})]})}),loans.length===0&&!isLoading&&/*#__PURE__*/_jsxs(\"div\",{style:{textAlign:'center',padding:'40px',color:'#666'},children:[/*#__PURE__*/_jsx(\"p\",{children:\"\\uD83D\\uDCED No hay pr\\xE9stamos registrados\"}),/*#__PURE__*/_jsx(\"p\",{children:\"Haz clic en \\\"Crear Pr\\xE9stamo\\\" para agregar el primero\"})]})]}),loans.length>0&&/*#__PURE__*/_jsxs(\"div\",{style:{marginTop:'30px',display:'grid',gridTemplateColumns:'repeat(auto-fit, minmax(200px, 1fr))',gap:'15px'},children:[/*#__PURE__*/_jsxs(\"div\",{style:{padding:'15px',backgroundColor:'#e3f2fd',borderRadius:'8px',textAlign:'center'},children:[/*#__PURE__*/_jsx(\"h3\",{style:{margin:'0 0 10px 0',color:'#1976d2'},children:\"\\uD83D\\uDCCA Total Pr\\xE9stamos\"}),/*#__PURE__*/_jsx(\"p\",{style:{fontSize:'24px',fontWeight:'bold',margin:0},children:loans.length})]}),/*#__PURE__*/_jsxs(\"div\",{style:{padding:'15px',backgroundColor:'#e8f5e8',borderRadius:'8px',textAlign:'center'},children:[/*#__PURE__*/_jsx(\"h3\",{style:{margin:'0 0 10px 0',color:'#388e3c'},children:\"\\u2705 En Pr\\xE9stamo\"}),/*#__PURE__*/_jsx(\"p\",{style:{fontSize:'24px',fontWeight:'bold',margin:0},children:loans.filter(l=>l.status==='en_prestamo').length})]}),/*#__PURE__*/_jsxs(\"div\",{style:{padding:'15px',backgroundColor:'#fff3e0',borderRadius:'8px',textAlign:'center'},children:[/*#__PURE__*/_jsx(\"h3\",{style:{margin:'0 0 10px 0',color:'#f57c00'},children:\"\\u26A0\\uFE0F Por Vencer\"}),/*#__PURE__*/_jsx(\"p\",{style:{fontSize:'24px',fontWeight:'bold',margin:0},children:loans.filter(l=>{const days=calculateDaysUntilDue(l.return_due_date);return days<=7&&days>=0&&l.status==='en_prestamo';}).length})]}),/*#__PURE__*/_jsxs(\"div\",{style:{padding:'15px',backgroundColor:'#ffebee',borderRadius:'8px',textAlign:'center'},children:[/*#__PURE__*/_jsx(\"h3\",{style:{margin:'0 0 10px 0',color:'#d32f2f'},children:\"\\uD83D\\uDEA8 Vencidos\"}),/*#__PURE__*/_jsx(\"p\",{style:{fontSize:'24px',fontWeight:'bold',margin:0},children:loans.filter(l=>calculateDaysUntilDue(l.return_due_date)<0&&l.status==='en_prestamo').length})]})]})]});};export default ConsignmentLoansPage;","map":null,"metadata":{},"sourceType":"module","externalDependencies":[]}